<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" src="../Source/Actor.js"></script>
  <script type="text/javascript" src="../Source/Physics.js"></script>
  <script type="text/javascript" src="../Source/Character.js"></script>
  <script type="text/javascript" src="../Source/DrawingTools.js"></script>
  <script type="text/javascript" src="../Source/characterEditModes.js"></script>
  <link rel="stylesheet" type="text/css" href="svgStyles.css">
</head>

<body>
  <style type="text/css">
    .tg {
      border-collapse: collapse;
      border-spacing: 0;
    }

      .tg td {
        font-family: Arial, sans-serif;
        font-size: 14px;
        padding: 10px 5px;
        border-style: solid;
        border-width: 1px;
        overflow: hidden;
        word-break: normal;
        border-color: black;
      }

      .tg th {
        font-family: Arial, sans-serif;
        font-size: 14px;
        font-weight: normal;
        padding: 10px 5px;
        border-style: solid;
        border-width: 1px;
        overflow: hidden;
        word-break: normal;
        border-color: black;
      }

      .tg .tg-upqx {
        background-color: #ffffff;
        border-color: #cbcefb
      }

      .tg .tg-97fk {
        background-color: #ffffff;
        border-color: #cbcefb;
        vertical-align: top
      }
  </style>
  <table class="tg">
    <tr>
      <th class="tg-upqx">
          <button id="btnNewCharacter" class="svgButton" onclick="createNewCharacter()">
              <img src="../SVGs/Buttons/NewCharacter.svg"/>
          </button>

        <button id="btnNewLimb" class="svgButton" onclick="createNewLimb()">
            <img src="../SVGs/Buttons/NewLimb.svg" />
        </button>

        <button id="btnNewLayer" class="svgButton" onclick="createNewLayer()">
            <img src="../SVGs/Buttons/NewLayer.svg" />
        </button>

      </th>
      <th class="tg-upqx" colspan="3">
        <input type="text" id="txtCharacterName" minlength="1" maxlength="255"
               placeholder="(character name)" oninput="characterNameChanged()" />
        <input type="text" id="txtCharacterScale" minlength="1" maxlength="255"
               placeholder="(character scale)" oninput="characterScaleChanged()" />

        <button id="btnScaleUp" class="svgButton repeatButton" onclick="scaleCharacterUp()">
            <img src="../SVGs/Buttons/ScaleUp.svg" />
        </button>


        <button id="btnScaleDown" class="svgButton repeatButton" onclick="scaleCharacterDown()">
            <img src="../SVGs/Buttons/ScaleDown.svg" />
        </button>
      </th>
      <th class="tg-97fk"></th>
    </tr>
    <tr>
      <td class="tg-97fk">
        Folder: <input type="text" value="Clyde" id="folderName"><br><br>
        Base File Name: <input value="WalkFrame" type="text" id="baseFileName"><br><br>
        Count: <input type="text" value="25" id="frameCount"><br><br>
        <button type="button" onclick="Load()">Load!</button>
      </td>
      <td class="tg-97fk" colspan="3">
        <canvas id="myCanvas" width="600" height="480" style="border:1px solid #C0C0C0;"
                onmousemove="canvasMouseMove(event)" onmousedown="canvasMouseDown(event)"></canvas>
      </td>
      <td class="tg-97fk"></td>
    </tr>
    <tr>
      <td class="tg-upqx">
          <button id="btnAnchorDrop" class="svgButton" onclick="dropAnchor()">
              <img src="../SVGs/Buttons/AnchorDrop.svg" />
          </button>
      </td>
      <td class="tg-upqx">
          <button id="btnBackFrame" class="svgNavButton repeatButton" onclick="advanceFrameBackward()">
              <img src="../SVGs/Buttons/BackFrame.svg" />
          </button>
      </td>
      <td class="tg-97fk"><input type="text" value="0" id="frameNumber" onchange="frameNumberTextChanged"></td>
      <td class="tg-97fk">
          <button id="btnForwardFrame" class="svgNavButton repeatButton" onclick="advanceFrameForward()">
              <img src="../SVGs/Buttons/ForwardFrame.svg" />
          </button>
      </td>
      <td class="tg-97fk"></td>
    </tr>
  </table>

  <script>
    var frameIndex = 0;
    var folderName;
    var baseFileName;
    var frameCount;
    var backgroundFrameImage;
    var scale = 0.5;
    var characterEditMode = characterEditModes.normal;

    function Load() {
      folderName = document.getElementById("folderName").value;
      baseFileName = document.getElementById("baseFileName").value;
      frameCount = document.getElementById("frameCount").value;

      backgroundFrameImage = new Image();
      backgroundFrameImage.onload = function () {
        myCanvas.width = backgroundFrameImage.width * scale;
        myCanvas.height = backgroundFrameImage.height * scale;
        refresh();
      };
      frameIndex = 0;
      loadImage();
    }

    function loadImage() {
      if (backgroundFrameImage)
        backgroundFrameImage.src = folderName + '/' + baseFileName + frameIndex + '.png';
    }

    function refresh() {
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.clientHeight);
      if (backgroundFrameImage)
        ctx.drawImage(backgroundFrameImage, 0, 0, backgroundFrameImage.width * scale, backgroundFrameImage.height * scale);
      character.draw(ctx);
      drawCursor();
    }

    function drawCursor() {
      if (cursor)
        cursor.draw(ctx);
    }

    function frameNumberTextChanged() {
      setFrameIndex(frameIndexTextBox.value);
    }

    function setFrameIndex(newIndex) {
      if (frameIndex == newIndex) {
        return;
      }
      frameIndex = newIndex;
      frameIndexChanged();
    }

    function frameIndexChanged() {
      loadImage();
      updateFrameNumber();
      refresh();
    }

    function advanceFrameForward() {
      if (!frameIndex)
        frameIndex = 0;
      frameIndex++;
      if (frameIndex >= frameCount)
        frameIndex = 0;
      frameIndexChanged();
    }

    function advanceFrameBackward() {
      if (!frameIndex)
        frameIndex = 0;
      frameIndex--;
      if (frameIndex < 0)
        frameIndex = frameCount - 1;
      frameIndexChanged();
    }

    function updateFrameNumber() {
      frameIndexTextBox.value = frameIndex;
    }

    function hasClass(childElement, className) {
      for (var index = 0; index < childElement.classList.length; index++) {
        var thisClassName = childElement.classList[index];
        if (thisClassName == className)
          return true;
      }
      return false;
    }

    function getBackground(button) {
      if (button.children.length > 0)
        return button.children[0];
    }

    function getForeground(button) {
      if (button.children.length > 0)
        return button.children[button.children.length - 1];
    }

    function createNewLimb(e) {
      console.log("createNewLimb!");
    }

    function createNewCharacter(e) {
      var charName = "(unnamed)";
      var torsoFileName = window.prompt("Torso File Name:", "ClydeFull.svg");
      if (torsoFileName == null || torsoFileName == "")
        return;

      character = new Character(charName, torsoFileName);
      refresh();
    }

    function createNewLayer(e) {
      console.log("createNewLayer!");
    }

    function characterNameChanged(e) {
      character.name = document.getElementById('txtCharacterName').value;
    }

    function characterScaleChanged(e) {
      character.scale = document.getElementById('txtCharacterScale').value;
      refresh();
    }

    function updateCharacter() {
      refresh();
    }

    function scaleCharacterUp() {
      //e.preventDefault();
      character.scale *= 1.1;
      refresh();
    }

    function scaleCharacterDown() {
      //e.preventDefault();
      if (character.scale < 0)
        character.scale = 1;
      character.scale = character.scale * 0.9;
      refresh();
    }


    function getMousePosInCanvas(canvas, evt) {
      var rect = canvas.getBoundingClientRect();
      return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
      };
    }

    function canvasMouseMove(e) {
      if (!cursor)
        return;

      var pos = getMousePosInCanvas(myCanvas, e);
      if (cursor) {
        cursor.x = pos.x;
        cursor.y = pos.y;
      }
    }

    function canvasMouseDown(e) {
      if (!cursor)
        return;

      cursor = null;
      characterEditMode = characterEditModes.spinTest;
      character.torso.spinning = true;
      var pos = getMousePosInCanvas(myCanvas, e);
      console.log('(' + pos.x + ', ' + pos.y + ')');
      var upperLeftX = pos.x - (character.x - character.torso.anchorX);
      var upperLeftY = pos.y - (character.y - character.torso.anchorY);
      console.log('Upper Left: (' + upperLeftX + ', ' + upperLeftY + ')');
      character.torso.anchorX = upperLeftX;
      character.torso.anchorY = upperLeftY;
      refresh();
    }

    function dropAnchor() {
      characterEditMode = characterEditModes.setAnchor;
      character.torso.spinning = false;
      character.scale = 1;
      cursor = new Actor(0, 0, 'TargetPinpoint.svg');
      cursor.anchorY = 90;
      refresh();
    }

        var cursor = null;
    var frameIndexTextBox = document.getElementById("frameNumber");

    // addSvgButton("btnNewCharacter", createNewCharacter);
    // addSvgButton("btnNewLimb", createNewLimb);
    // addSvgButton("btnNewLayer", createNewLayer);
    // addSvgButton("btnBackFrame");
    // addSvgButton("btnForwardFrame");
    // addSvgButton("btnScaleUp", scaleCharacterUp);
    // addSvgButton("btnScaleDown", scaleCharacterDown);

    function configureRepeatButtons() {
        var buttons = document.getElementsByClassName("repeatButton");
        for (var i = 0; i < buttons.length; i++) {
            var button = buttons[i];
            button.addEventListener("animationiteration", function (e) {
                var event = document.createEvent("MouseEvents");
                event.initEvent("click", true, true);
                event.synthetic = true;
                this.dispatchEvent(event, true);
            }, false);
        }
    }

    configureRepeatButtons();
    var myCanvas = document.getElementById("myCanvas");
    var ctx = myCanvas.getContext("2d");
    var character = new Character("clyde", "ClydeFull.svg");
    character.torso.spinning = true;

    const clydeBodyCenterX = 236;
    const clydeBodyCenterY = 150;
    const clydeThighCenterX = 223;
    const clydeThighCenterY = 275;
    const clydeEyeCenterX = 380;
    const clydeEyeCenterY = 150;
    //character.torso.anchorX = clydeThighCenterX;
    //character.torso.anchorY = clydeThighCenterY;

    character.torso.anchorX = clydeEyeCenterX;
    character.torso.anchorY = clydeEyeCenterY;
    gravity = 0;
    setInterval(updateCharacter, 10);
  </script>
</body>
</html>
